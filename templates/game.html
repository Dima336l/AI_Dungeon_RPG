<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <title>MMO Dungeon</title>
</head>
<body>

  <!-- Header -->
  <h1 class="page-title">MMO Dungeon</h1>

  <!-- Main content: monitor + start button -->
  <div class="main-content">
    <div class="monitor-frame">
      <img src="{{ url_for('static', filename='retro_monitor.jpg') }}" alt="Retro Monitor" class="monitor-img" />
      <div class="monitor-screen">
        <div id="book-container">
          <div id="page">
            <h1>AI Dungeon</h1>
            <div id="content-area">
              <div id="scene-text"></div>
              <div id="scene-image-container"></div>
              <div id="choices"></div>
            </div>
            <div id="player-status" style="display:none;">{{ player_status }}</div>
          </div>
        </div>
        <button id="start-btn">Start Adventure</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div id="footer-buttons">
      <button id="music-toggle">üéµ Music</button>
      <button id="restart-btn">üîÑ Restart</button>
      <button id="settings-btn">‚öôÔ∏è Settings</button>
    </div>

  </div>

  <!-- ===== Scripts ===== -->
  <script>
    // === Game Data ===
    const initialSceneText = {{ scene|tojson }};
    const initialOptions = {{ options|tojson }};
    const initialSceneImage = "{{ scene_image }}";
    const initialPlayerStatus = "{{ player_status }}";

    let isTyping = false;
    let currentSceneId = null;

    // === Typing Function ===
    function typeSceneText(sceneText, callback) {
      const sceneDiv = document.getElementById('scene-text');
      sceneDiv.textContent = '\u200B'; // prevent initial RTL glitch
      sceneDiv.classList.add('typing-cursor');
      isTyping = true;
      let i = 0;
      function typeNext() {
        if (i < sceneText.length) {
          sceneDiv.textContent = sceneText.substring(0, i + 1);
          i++;
          setTimeout(typeNext, 30);
        } else {
          sceneDiv.classList.remove('typing-cursor');
          isTyping = false;
          if (callback) setTimeout(callback, 500);
        }
      }
      typeNext();
    }


    // === Scene Image Functions ===
    function clearSceneImage() {
      document.getElementById('scene-image-container').innerHTML = '';
    }
    function showSceneImage(sceneImageUrl, callback) {
      if (!sceneImageUrl) { if (callback) setTimeout(callback,100); return; }
      const container = document.getElementById('scene-image-container');
      container.innerHTML = '';
      const img = document.createElement('img');
      img.src = sceneImageUrl;
      img.alt = 'Scene image';
      img.onload = () => setTimeout(() => { img.classList.add('show'); if(callback) setTimeout(callback,600); },100);
      img.onerror = () => { console.log('Image failed to load'); if(callback) setTimeout(callback,100); };
      container.appendChild(img);
    }

    // === Image Polling ===
    function checkImageReady(sceneId, callback) {
      if (!sceneId) { callback(null); return; }
      fetch(`/get_image/${sceneId}`)
        .then(res => res.json())
        .then(data => {
          if (data.ready && data.image_url) callback(data.image_url);
          else setTimeout(() => checkImageReady(sceneId,callback),500);
        })
        .catch(e=>{ console.error(e); callback(null); });
    }

    // === Choices ===
    function updateChoices(options) {
      const choicesDiv = document.getElementById('choices');
      choicesDiv.innerHTML = '';
      choicesDiv.classList.remove('show');
      for (const [num,text] of Object.entries(options)) {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = text;
        btn.onclick = () => makeChoice(num);
        choicesDiv.appendChild(btn);
      }
      setTimeout(()=>choicesDiv.classList.add('show'),100);
    }

    // === Player Status ===
    function updatePlayerStatus(status) {
      const statusDiv = document.getElementById('player-status');
      statusDiv.textContent = status;
      statusDiv.style.display = 'block';
    }

    // === Update Full Scene ===
    function updateScene(sceneText, options, sceneId, playerStatus) {
      updatePlayerStatus(playerStatus);
      currentSceneId = sceneId;
      typeSceneText(sceneText, () => {
        if(sceneId) checkImageReady(sceneId, imgUrl => showSceneImage(imgUrl,()=>updateChoices(options)));
        else updateChoices(options);
      });
    }

    // === Make Choice ===
    function makeChoice(choiceNum) {
      if(isTyping) return;
      document.getElementById('choices').classList.remove('show');
      clearSceneImage();
      fetch('/make_choice', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({choice:choiceNum})
      }).then(res=>res.json()).then(data=>{
        updateScene(data.scene, data.options, data.scene_id, data.player_status);
      }).catch(e=>console.error(e));
    }

    // === Start Button ===
    // Start button click
    document.getElementById('start-btn').addEventListener('click', function() {
      this.style.display = 'none';

      // After starting, top-align content
      document.getElementById('page').style.justifyContent = 'flex-start';

      updatePlayerStatus(initialPlayerStatus);
      typeSceneText(initialSceneText, () => 
        showSceneImage(initialSceneImage, () => updateChoices(initialOptions))
      );
    });


    // === Footer Buttons ===
    (function initControls(){
      const musicBtn=document.getElementById('music-toggle');
      const restartBtn=document.getElementById('restart-btn');
      const settingsBtn=document.getElementById('settings-btn');
      if(!musicBtn||!restartBtn||!settingsBtn) return;
      let music=null,musicPlaying=false;
      try{ music = new Audio("{{ url_for('static', filename='music.mp3') }}"); music.loop=true;}catch(e){}
      musicBtn.addEventListener('click',()=>{if(!music)return; musicPlaying?music.pause():music.play(); musicPlaying=!musicPlaying;});
      restartBtn.addEventListener('click',()=>{window.location.href="/";});
      settingsBtn.addEventListener('click',()=>{alert("Settings coming soon!");});
    })();
  </script>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
