<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<title>AI Dungeon</title>
</head>
<body>
<div id="game-container">
  <h1>AI Dungeon</h1>
  
  <button id="start-btn">Start Game</button>
  
  <div id="scene-text" style="white-space: pre-wrap;"></div>
  
  <ul id="options" style="opacity: 0; pointer-events: none;"></ul>
  
  <div id="status-bar" style="opacity: 0;"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('start-btn');
    const sceneElem = document.getElementById('scene-text');
    const optionsElem = document.getElementById('options');
    const statusElem = document.getElementById('status-bar');
    const fullText = `{{ scene | safe }}`;
    const optionsData = {{ options | tojson }};
    const beep = new Audio('{{ url_for("static", filename="beep.wav") }}');

    // Hide options and status initially
    optionsElem.style.opacity = 0;
    optionsElem.style.pointerEvents = 'none';
    statusElem.style.opacity = 0;

    function typeText(element, text, speed = 30, callback) {
      let index = 0;
      element.textContent = '';

      function type() {
        if (index < text.length) {
          element.textContent += text.charAt(index);
          if (text.charAt(index).match(/[a-z0-9]/i)) {
            beep.currentTime = 0;
            beep.play();
          }
          index++;
          setTimeout(type, speed);
        } else if (callback) {
          callback();
        }
      }

      type();
    }

    // Keyboard shortcut for choices 1-9
    document.addEventListener('keydown', (e) => {
      if (e.key >= '1' && e.key <= '9') {
        const choice = e.key;
        const optionElem = optionsElem.querySelector(`li[data-option="${choice}"]`);
        if (optionElem) {
          optionElem.click();
        }
      }
    });

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none'; // Hide start button

      typeText(sceneElem, fullText, 30, () => {
        // After typing finishes, show options and status
        optionsElem.style.opacity = 1;
        optionsElem.style.pointerEvents = 'auto';
        statusElem.style.opacity = 1;

        // Populate options list
        optionsElem.innerHTML = '';
        for (const [num, option] of Object.entries(optionsData)) {
          const li = document.createElement('li');
          li.setAttribute('data-option', num);
          li.textContent = `${num}. ${option}`;
          optionsElem.appendChild(li);
        }

        // Attach click handlers to options
        optionsElem.querySelectorAll('li').forEach(item => {
          item.addEventListener('click', () => {
            const choice = item.getAttribute('data-option');
            fetch("/", {
              method: "POST",
              headers: {"Content-Type": "application/x-www-form-urlencoded"},
              body: `choice=${choice}`
            }).then(() => {
              window.location.reload();
            });
          });
        });
      });
    });
  });
</script>

</body>
</html>
